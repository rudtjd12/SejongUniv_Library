<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ìŠ¤ë§ˆíŠ¸ ì¢Œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }
        .card {
            background: #ffffff;
            padding: 24px 28px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            max-width: 360px;
            width: 100%;
        }
        .seat-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        .status {
            font-size: 18px;
            margin: 16px 0;
        }
        .status span {
            font-weight: 700;
        }
        .status-enter { color: #2e7d32; } /* ì…ì‹¤: ë…¹ìƒ‰ */
        .status-out { color: #f9a825; }   /* ì™¸ì¶œ: ë…¸ë‘ */
        
        .student-line {
            font-size: 16px;
            margin-top: 4px;
            border-top: 1px solid #ddd;
            padding-top: 8px;
            margin-bottom: 12px;
        }
        .student-line span { font-weight: 600; color: #333; }

        .timer-box {
            background: #ffebee;
            color: #c62828;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: bold;
            display: none; /* ì™¸ì¶œ ì‹œì—ë§Œ ë³´ì„ */
        }

        .warning-box {
            font-size: 13px;
            color: #d32f2f;
            margin-bottom: 10px;
            background: #fff3e0;
            padding: 6px;
            border-radius: 4px;
            display: none;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 14px;
            font-size: 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary { background: #1976d2; color: #fff; }
        .btn-secondary { background: #eeeeee; color: #333; }
        .btn-danger { background: #d32f2f; color: #fff; }
        .btn-test { background: #666; color: #fff; font-size: 11px; margin-top: 20px; }

        #idInput {
            width: 100%;
            padding: 8px 10px;
            font-size: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .info {
            margin-top: 10px;
            font-size: 11px;
            color: #666;
        }
        .error {
            color: #c62828;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }
    </style>
</head>
<body>

<div class="card" id="id-card">
    <div id="seat-title-form" class="seat-title">ì¢Œì„ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <input id="idInput" type="text" placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="idSubmit" class="btn-primary">ë¡œê·¸ì¸ / ì¢Œì„ ë°°ì •</button>
    <div id="idError" class="error"></div>
    <div class="info">í•™ë²ˆì„ ì…ë ¥í•˜ë©´ í•´ë‹¹ í•™ìƒì˜ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.</div>
</div>

<div class="card" id="seat-card" style="display:none;">
    <div id="seat-title" class="seat-title"></div>

    <div class="student-line">
        ì‚¬ìš©ì: <span id="student-id-text">-</span>
    </div>

    <div id="warning-display" class="warning-box">
        âš ï¸ ëˆ„ì  ê²½ê³ : <span id="warning-count">0</span>íšŒ (3íšŒì‹œ 2ì£¼ ì •ì§€)
    </div>

    <div id="status" class="status">ìƒíƒœ: <span>ì…ì‹¤ ì¤‘</span></div>

    <div id="out-timer-box" class="timer-box">
        ì™¸ì¶œ ì‹œê°„: <span id="timer-text">00:00:00</span>
        <div style="font-size:11px; font-weight:normal; margin-top:4px;">(3ì‹œê°„ ì´ˆê³¼ ì‹œ ê²½ê³  1íšŒ)</div>
    </div>

    <div class="btn-row">
        <div id="controls-in" style="display:block;">
            <button class="btn-secondary" id="btn-go-out">ì™¸ì¶œ í•˜ê¸°</button>
            <button class="btn-danger" id="btn-leave">í‡´ì‹¤ (ì‚¬ìš© ì¢…ë£Œ)</button>
        </div>
        
        <div id="controls-out" style="display:none;">
            <button class="btn-primary" id="btn-return">ë³µê·€ (ì™¸ì¶œ ì¢…ë£Œ)</button>
            <button class="btn-danger" id="btn-leave-out">ë°”ë¡œ í‡´ì‹¤</button>
        </div>
    </div>

    <button id="btn-test-add-time" class="btn-test">[í…ŒìŠ¤íŠ¸] ì™¸ì¶œ ì‹œê°„ +3ì‹œê°„ ì¶”ê°€</button>

    <div class="info">í‡´ì‹¤ ì‹œ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.</div>
</div>

<script>
    // --- ìƒìˆ˜ ë° ì„¤ì • ---
    const WARNING_LIMIT_MS = 3 * 60 * 60 * 1000; // 3ì‹œê°„ (ë°€ë¦¬ì´ˆ)
    // const WARNING_LIMIT_MS = 5000; // í…ŒìŠ¤íŠ¸ìš©: 5ì´ˆ
    const BAN_DURATION_MS = 14 * 24 * 60 * 60 * 1000; // 2ì£¼ (ë°€ë¦¬ì´ˆ)

    // URL íŒŒë¼ë¯¸í„° í™•ì¸ (?seat=1)
    const params = new URLSearchParams(window.location.search);
    const seatNum = params.get("seat");

    // DOM ìš”ì†Œ
    const idCard = document.getElementById("id-card");
    const seatCard = document.getElementById("seat-card");
    const idInputEl = document.getElementById("idInput");
    const idErrorEl = document.getElementById("idError");
    const seatTitleFormEl = document.getElementById("seat-title-form");
    const seatTitleEl = document.getElementById("seat-title");
    
    // ëŒ€ì‹œë³´ë“œ ìš”ì†Œ
    const studentIdTextEl = document.getElementById("student-id-text");
    const warningCountEl = document.getElementById("warning-count");
    const statusTextEl = document.querySelector("#status span");
    const timerBox = document.getElementById("out-timer-box");
    const timerText = document.getElementById("timer-text");
    const warningDisplay = document.getElementById("warning-display");

    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹
    const controlsIn = document.getElementById("controls-in");
    const controlsOut = document.getElementById("controls-out");

    // ìƒíƒœ ë³€ìˆ˜
    let currentId = "";
    let timerInterval = null;

    // --- ì´ˆê¸°í™” ë¡œì§ ---
    if (!seatNum) {
        seatTitleFormEl.textContent = "ì¢Œì„ ë²ˆí˜¸ ì˜¤ë¥˜";
        idErrorEl.style.display = "block";
        idErrorEl.textContent = "URLì— ?seat=ë²ˆí˜¸ í˜•ì‹ì´ í•„ìš”í•©ë‹ˆë‹¤.";
        document.getElementById("idSubmit").disabled = true;
    } else {
        seatTitleFormEl.textContent = `${seatNum}ë²ˆ ì¢Œì„ ë¡œê·¸ì¸`;
        seatTitleEl.textContent = `${seatNum}ë²ˆ ì¢Œì„ ê´€ë¦¬`;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ, ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœì¸ì§€ í™•ì¸ (ìƒˆë¡œê³ ì¹¨ ëŒ€ì‘)
        const savedId = localStorage.getItem(`seat_${seatNum}_studentId`);
        if (savedId) {
            login(savedId);
        }
    }

    // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

    // 1. ë¡œê·¸ì¸ (í•™ë²ˆ ì…ë ¥)
    document.getElementById("idSubmit").addEventListener("click", () => {
        const inputId = idInputEl.value.trim();
        if (!inputId) {
            showError("í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        // ì •ì§€(Ban) ì—¬ë¶€ í™•ì¸
        const banInfo = getStudentBanInfo(inputId); // { isBanned: bool, date: string }
        if (banInfo.isBanned) {
            showError(`í•´ë‹¹ í•™ë²ˆì€ ì´ìš©ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\ní•´ì œì¼: ${banInfo.date}`);
            return;
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        localStorage.setItem(`seat_${seatNum}_studentId`, inputId);
        login(inputId);
    });

    // 2. ì™¸ì¶œ ë²„íŠ¼
    document.getElementById("btn-go-out").addEventListener("click", () => {
        setOutStatus();
    });

    // 3. ë³µê·€ ë²„íŠ¼ (ì™¸ì¶œ ë)
    document.getElementById("btn-return").addEventListener("click", () => {
        checkOutDurationAndProcess(); // ì‹œê°„ ì²´í¬ í›„ ê²½ê³  ë¶€ì—¬ íŒë‹¨
        setInStatus(); // ì…ì‹¤ ìƒíƒœë¡œ ë³€ê²½
    });

    // 4. í‡´ì‹¤ ë²„íŠ¼ (ì…ì‹¤ ì¤‘ í‡´ì‹¤)
    document.getElementById("btn-leave").addEventListener("click", () => {
        logout();
    });

    // 5. ì™¸ì¶œ ì¤‘ í‡´ì‹¤ (ë°”ë¡œ í‡´ì‹¤)
    document.getElementById("btn-leave-out").addEventListener("click", () => {
        checkOutDurationAndProcess(); // ì™¸ì¶œ ì‹œê°„ ì²´í¬ (ê²½ê³  ë¶€ì—¬ ê°€ëŠ¥)
        logout();
    });

    // 6. [í…ŒìŠ¤íŠ¸ìš©] 3ì‹œê°„ ì¶”ê°€ ë²„íŠ¼
    document.getElementById("btn-test-add-time").addEventListener("click", () => {
        const outStartKey = `seat_${seatNum}_outStartTime`;
        let startTime = parseInt(localStorage.getItem(outStartKey));
        if (startTime) {
            // ì‹œì‘ ì‹œê°„ì„ 3ì‹œê°„ 1ë¶„ ì „ìœ¼ë¡œ ëŒë¦¼
            const newStartTime = startTime - (3 * 60 * 60 * 1000) - (60 * 1000);
            localStorage.setItem(outStartKey, newStartTime);
            alert("í…ŒìŠ¤íŠ¸: ì™¸ì¶œ ì‹œì‘ ì‹œê°„ì„ 3ì‹œê°„ ì „ìœ¼ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.");
        } else {
            alert("ì™¸ì¶œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.");
        }
    });


    // --- í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---

    function login(id) {
        currentId = id;
        idInputEl.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        idErrorEl.style.display = "none";
        
        // í™”ë©´ ì „í™˜
        idCard.style.display = "none";
        seatCard.style.display = "block";
        studentIdTextEl.textContent = currentId;

        // í•™ìƒ ê²½ê³  íšŸìˆ˜ ë¡œë“œ
        updateWarningDisplay();

        // í˜„ì¬ ìƒíƒœ ë³µêµ¬ (ì…ì‹¤ ì¤‘ì¸ì§€ ì™¸ì¶œ ì¤‘ì¸ì§€)
        const savedStatus = localStorage.getItem(`seat_${seatNum}_status`) || "ì…ì‹¤";
        if (savedStatus === "ì™¸ì¶œ") {
            resumeOutStatus();
        } else {
            setInStatus(false); // false = ìƒíƒœ ì €ì¥ ì—†ì´ UIë§Œ ê°±ì‹ 
        }
    }

    function logout() {
        // ë°ì´í„° ì´ˆê¸°í™”
        localStorage.removeItem(`seat_${seatNum}_studentId`);
        localStorage.removeItem(`seat_${seatNum}_status`);
        localStorage.removeItem(`seat_${seatNum}_outStartTime`);
        
        if (timerInterval) clearInterval(timerInterval);
        currentId = "";

        // í™”ë©´ ì „í™˜ (ì²« í™”ë©´ìœ¼ë¡œ)
        seatCard.style.display = "none";
        idCard.style.display = "block";
        alert("í‡´ì‹¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!");
    }

    // ìƒíƒœ ë³€ê²½: ì…ì‹¤(ë³µê·€)
    function setInStatus(save = true) {
        if(save) localStorage.setItem(`seat_${seatNum}_status`, "ì…ì‹¤");
        localStorage.removeItem(`seat_${seatNum}_outStartTime`); // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œê°„ ì‚­ì œ
        
        statusTextEl.textContent = "ì…ì‹¤ ì¤‘";
        statusTextEl.className = "status-enter";
        
        controlsIn.style.display = "block";
        controlsOut.style.display = "none";
        timerBox.style.display = "none";
        
        if (timerInterval) clearInterval(timerInterval);
    }

    // ìƒíƒœ ë³€ê²½: ì™¸ì¶œ ì‹œì‘
    function setOutStatus() {
        const now = Date.now();
        localStorage.setItem(`seat_${seatNum}_status`, "ì™¸ì¶œ");
        localStorage.setItem(`seat_${seatNum}_outStartTime`, now);

        resumeOutStatus();
    }

    // ì™¸ì¶œ ìƒíƒœ UI ë° íƒ€ì´ë¨¸ ê°€ë™
    function resumeOutStatus() {
        statusTextEl.textContent = "ì™¸ì¶œ ì¤‘";
        statusTextEl.className = "status-out";

        controlsIn.style.display = "none";
        controlsOut.style.display = "block";
        timerBox.style.display = "block";

        // íƒ€ì´ë¨¸ ì‹œì‘
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer(); // ì¦‰ì‹œ ì‹¤í–‰
    }

    // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤ ì‹¤í–‰)
    function updateTimer() {
        const startTime = parseInt(localStorage.getItem(`seat_${seatNum}_outStartTime`));
        if (!startTime) return;

        const now = Date.now();
        const diff = now - startTime;

        // ì‹œ:ë¶„:ì´ˆ ê³„ì‚°
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        const fmt = (n) => n.toString().padStart(2, '0');
        timerText.textContent = `${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}`;
        
        // 3ì‹œê°„ ë„˜ìœ¼ë©´ ë¹¨ê°„ìƒ‰ ê°•ì¡°
        if (diff > WARNING_LIMIT_MS) {
            timerText.style.color = "red";
            timerText.style.fontWeight = "900";
        } else {
            timerText.style.color = "#c62828";
        }
    }

    // ì™¸ì¶œ ì‹œê°„ ì²´í¬ ë° ê²½ê³  ë¶€ì—¬ ë¡œì§
    function checkOutDurationAndProcess() {
        const startTime = parseInt(localStorage.getItem(`seat_${seatNum}_outStartTime`));
        if (!startTime) return;

        const now = Date.now();
        const diff = now - startTime;

        // 3ì‹œê°„ ì´ˆê³¼ ì‹œ
        if (diff > WARNING_LIMIT_MS) {
            addWarning(currentId);
        }
    }

    // --- í•™ìƒ ë°ì´í„° ê´€ë¦¬ (ê²½ê³ /ì •ì§€) ---
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í‚¤: student_{í•™ë²ˆ}_warnings, student_{í•™ë²ˆ}_banDate

    function getStudentBanInfo(id) {
        const banDateStr = localStorage.getItem(`student_${id}_banDate`);
        if (banDateStr) {
            const banDate = new Date(parseInt(banDateStr));
            if (new Date() < banDate) {
                return { isBanned: true, date: banDate.toLocaleString() };
            } else {
                // ê¸°ê°„ ì§€ë‚¬ìœ¼ë©´ í•´ì œ
                localStorage.removeItem(`student_${id}_banDate`);
                localStorage.removeItem(`student_${id}_warnings`); // ê²½ê³ ë„ ì´ˆê¸°í™”í•´ì¤„ì§€ ì—¬ë¶€ëŠ” ì •ì±… ë‚˜ë¦„(ì—¬ê¸°ì„  ì´ˆê¸°í™”)
            }
        }
        return { isBanned: false };
    }

    function addWarning(id) {
        let warnings = parseInt(localStorage.getItem(`student_${id}_warnings`) || "0");
        warnings++;
        localStorage.setItem(`student_${id}_warnings`, warnings);

        alert(`[ê²½ê³  ì•Œë¦¼] ì™¸ì¶œ ì‹œê°„ì´ 3ì‹œê°„ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ëˆ„ì  ê²½ê³ : ${warnings}íšŒ`);

        if (warnings >= 3) {
            const banEndDate = Date.now() + BAN_DURATION_MS;
            localStorage.setItem(`student_${id}_banDate`, banEndDate);
            alert(`ğŸš¨ ê²½ê³  3íšŒ ëˆ„ì !\nì˜¤ëŠ˜ë¶€í„° 2ì£¼ê°„ ì¢Œì„ ì´ìš©ì´ ê¸ˆì§€ë©ë‹ˆë‹¤.`);
        }
        
        updateWarningDisplay();
    }

    function updateWarningDisplay() {
        const warnings = localStorage.getItem(`student_${currentId}_warnings`) || "0";
        warningCountEl.textContent = warnings;
        warningDisplay.style.display = "block";
    }

    function showError(msg) {
        idErrorEl.textContent = msg;
        idErrorEl.style.display = "block";
    }

</script>

</body>
</html>
